# NexusFabric 部署文档
#### 一. 准备环境
##### 1.服务器规划

##### 2.网络要求

要求各机器各组件正常运行提供如下的网络端口配置：

| 组件 | 默认端口 | 说明 |
| --- | --- | --- |
| DDHApplicationServer | 8081、2551、8586 | 8081为http server端口，2551为rpc通信端口，8586为jmx端口 |
|WorkerApplicationServer  | 2552、9100、8585 | 2552 rpc通信端口，8585为jmx端口，9100为主机数据采集器端口 |
| nginx | 8888 | 提供 UI 端通信端口 |

DDHApplicationServer为API接口层即web后端，主要负责处理前端UI层的请求。该服务统一提供RESTful api向外部提供请求服务。
WorkerApplicationServer负责执行DDHApplicationServer发送的指令，包括服务安装、启动、停止、重启等指令。

##### 3.浏览器要求
   推荐使用 Chrome 或是 Chrome内核的浏览器以访问可视化管理页面   
   
##### 4.修改主机名
    hostnamectl set-hostname bigdata-ywh-xxx
##### 5.修改/etc/hosts文件 
```
vim /etc/hosts
#贴入（示例）
172.27.216.xxx bigdata-xxx-234
172.27.216.xxx bigdata-xxx-235
172.27.216.xxx bigdata-xxx-248
172.27.216.xxx bigdata-xxx-249
172.27.216.xxx bigdata-xxx-250
```

##### 6.设置ssh免密

一路回车 设置无密码密钥   
```
ssh-keygen -t rsa   
```

在各节点获取公钥  
```
 cat ~/.ssh/id_ras_pub  
```
把cat的内容 按行填充到 master节点的
```
~/.ssh/authorized_keys 
```
测试节点之间互联 bigdata-xxx-250 执行
  
```
 ssh bigdata-xxx-248
```

##### 7.修改打开文件数[在每个节点都需要执行]
```
echo '* soft nofile 1024000' >>/etc/security/limits.conf
echo '* hard nofile 1024000' >>/etc/security/limits.conf 
```
  
   
##### 8.关闭防火墙，selinux
```
systemctl stop firewalld.service
systemctl disable firewalld.service
vim /etc/selinux/config
#修改
SELINUX=disabled
```

##### 9.设置ntp时钟同步

```
#先查看是否已经安装ntp
rpm -q ntp 
#没有则安装
yum install ntp
#设置自启
systemctl enable ntpd.service
chkconfig --list ntpd
```

#### 二.开始部署

##### 1.创建部署包路径，将DDP按照包拷贝到此目录
在bigdata-ywh-248 执行
```
mkdir -p /opt/datasophon/DDP/packages 
```
拷贝 DDP 安装包到 packages下

![图片1.png](./i18n/zh-Hans/docusaurus-plugin-content-docs/current/部署文档/imgs/图片1.png)

将/data1/opt/datasophon/DDP/packages/datasophon-manager-1.2.3.tar.gz 解压到 /opt/datasophon 目录
```
tar zxvf /opt/datasophon/DDP/packages/datasophon-manager-1.2.3.tar.gz -C /opt/datasophon/
```

解压之后的文件夹结构如下：
├── bin               # 执行脚本目录
├── conf              # 配置文件目录
├── lib               # 项目依赖目录
├── (logs)            # 日志目录；应用运行后生成
├── jmx               # jmx插件目录
├── datasophon-init   # 环境初始化脚本
├── README.md         # 说明
├── Dockerfile        # 容器构建脚本
└── LICENSE

##### 2.安装jdk1.8

#每个节点上都执行

```
sudo yum update
java -version
```
#搜索可用的OpenJDK软件包

```
sudo yum search openjdk
```
#安装

```
sudo yum install -y java-1.8.0-openjdk-devel
```

##### 3.在master节点上安装mysql5.7

#添加MySQL 5.7的Yum仓库，并禁用其他版本的默认仓库。

```
sudo rpm -Uvh http://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm
```
#确保安装的是MySQL 5.7版本

```
sudo yum install -y yum-utils
sudo yum-config-manager --disable mysql80-community  # 禁用MySQL 8.0仓库
sudo yum-config-manager --enable mysql57-community   # 启用MySQL 5.7仓库
```
#Yum安装MySQL服务器及相关组件

```
#跳过密钥
sudo yum install --nogpgcheck -y mysql-server 
```
  
#启动MySQL服务并设置开机自启

```
sudo systemctl start mysqld
sudo systemctl enable mysqld
```
#获取初始密码并配置安全设置

```
sudo grep 'temporary password' /var/log/mysqld.log
```
#运行安全配置向导

```
sudo mysql_secure_installation
```
#调整密码策略

```
SET GLOBAL validate_password_policy = 'LOW';
```

创建数据库，添加用户

```
CREATE DATABASE IF NOT EXISTS datasophon DEFAULT CHARACTER SET utf8;
grant all privileges on *.* to datasophon@"%" identified by 'datasophon' with grant option;
GRANT ALL PRIVILEGES ON *.* TO 'datasophon'@'%';
FLUSH PRIVILEGES;
```

##### 4.修改配置文件

```
vim conf/datasophon.conf
datasource.ip=localhost           # 数据库IP或域名
datasource.port=3306              # 数据库端口
datasource.database=datasophon    # 数据库名称
datasource.username=root          # 用户名
datasource.password=root          # 密码
server.port=                      # 服务启动端口(可选)     
```

##### 5.启动DataSophon

```
启动：sh bin/datasophon-api.sh start api
停止：sh bin/datasophon-api.sh stop api
重启：sh bin/datasophon-api.sh restart api 
```
  

部署成功后，可以进行日志查看，日志统一存放于logs文件夹内:
logs/
├── ddh-api.log
├── ddh-api-error.log
|—— api-{hostname}.out

##### 6.访问页面

前端页面：http://部署服务器:8081/ddh

登录的用户名密码：admin/admin123